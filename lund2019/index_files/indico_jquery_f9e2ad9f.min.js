$.datepicker.setDefaults({autoSize:true,buttonText:'',dateFormat:'dd/mm/yy',firstDay:1,nextText:$T('Next'),prevText:$T('Previous'),showOn:'both'});$.extend(true,$.indico.daterange.prototype.options,{pickerOptions:{dateFormat:'dd/mm/yy'},labelAttrs:{class:'label titleCellFormat'},labels:[$T('Choose the start date'),$T('Choose the end date')]});$.fn.qtip.defaults=$.extend(true,{},$.fn.qtip.defaults,{position:{my:'top left',at:'bottom right',viewport:$(window)},style:{tip:{corner:true}}});$.extend($.colorbox.settings,{opacity:0.6});$.tablesorter.defaults.sortReset=true;$.ajaxSetup({traditional:true,beforeSend:function(xhr,settings){'use strict';if(!/^https?:.*/.test(settings.url)){xhr.setRequestHeader('X-CSRF-Token',$('#csrf-token').attr('content'));}}});if(window.Dropzone){window.Dropzone.autoDiscover=false;}
$(document).ready(function(){'use strict';$('.static-tabs').each(function(){var tabCtrl=$(this);tabCtrl.tabs({active:tabCtrl.data('active')});$('> .ui-tabs-nav a',this).each(function(){var $this=$(this);tabCtrl.data('ui-tabs')._off($this,'click');$this.attr('href',$this.data('href'));});});$('.static-tabs').find('.ui-widget-content').addBack().removeClass('ui-widget-content');$('.main-breadcrumb a[href="#"]').css({cursor:'default',outline:'none'}).on('click',function(e){e.preventDefault();});$.fn.qtip.defaults=$.extend(true,{},$.fn.qtip.defaults,{position:{my:'top center',at:'bottom center'},hide:{event:'click mouseout'}});$('.contextHelp[title]').qtip();$(document).on("mouseenter",'[title]:not([title=""]):not(iframe), [data-qtip-html], [data-qtip-oldtitle]:not(iframe)',function(evt){var $target=$(this);var title=($target.attr('title')||$target.data('qtip-oldtitle')||'').trim();var extraOpts=$(this).data('qtip-opts')||{};var qtipClass=$(this).data('qtip-style');var qtipHTMLContainer=$(this).data('qtip-html');var qtipHTML=(qtipHTMLContainer&&qtipHTMLContainer.length)?$(this).next(qtipHTMLContainer):null;if((!qtipHTML&&!title)||this.disabled||$target.data('no-auto-tooltip')){return;}
$target.attr('data-qtip-oldtitle',title);$target.removeAttr('title');var position=$(this).data('qtip-position');var positionOptions;if(position==="left"){positionOptions={my:'right center',at:'left center'};}else if(position==="right"){positionOptions={my:'left center',at:'right center'};}else if(position==="top"){positionOptions={my:'bottom center',at:'top center'};}
var qtip=$('<span>').qtip($.extend(true,{},{overwrite:false,position:$.extend({target:$target},positionOptions),show:{event:evt.type,ready:true},content:{text:function(){if(qtipHTML){return qtipHTML.html();}else{return title.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");}}},events:{show:function(event){if($(event.originalEvent.target).hasClass('open')){event.preventDefault();}},hide:function(){$(this).qtip('destroy');},render:function(event,api){$target.on('DOMNodeRemovedFromDocument remove',function(){api.destroy();});}},hide:{event:'mouseleave',target:$target},style:{classes:qtipClass?'qtip-'+qtipClass:null}},extraOpts),evt);$target.on('indico:closeAutoTooltip',function(){qtip.qtip('hide');});});$('body').on('click','a.js-lightbox',function(){$(this).colorbox({maxHeight:'90%',maxWidth:'90%',loop:false,photo:true,returnFocus:false});});$('body').on('click','a.disabled',function(evt){evt.preventDefault();});$('.contextHelp[data-src]').qtip({content:{text:function(){return $($(this).data('src')).removeClass('tip');}}});function initDropdowns($container){$container.find('.js-dropdown').each(function(){$(this).parent().dropdown({selector:'.js-dropdown'});});}
$('body').on('indico:htmlUpdated',function(evt){initDropdowns($(evt.target));});initDropdowns($('body'));if(navigator.userAgent.match(/Trident\/7\./)){$('input:password').each(function(){if(!this.value&&this.getAttribute('value')){this.value=this.getAttribute('value');}});}
function getMaxZ(elem){var maxZ=0;elem.parents().addBack().each(function(){var z=+$(this).css('zIndex');if(!isNaN(z)){maxZ=Math.max(z,maxZ);}});return maxZ;}
$('body').on('focusin',function(e){if(!$.ui.dialog.overlayInstances){return;}
if(getMaxZ($(e.target))>getMaxZ($('.ui-dialog:visible:last'))){e.stopPropagation();}});$('input, textarea').on('keydown',function(e){if(this.readOnly&&e.which===K.BACKSPACE){e.preventDefault();}});$('input.permalink').on('focus',function(){this.select();});showFormErrors();var match=location.hash.match(/^#create-event:(lecture|meeting|conference)(?::(\d+))?$/);if(match){var eventType=match[1];var categoryId=match[2];var title={lecture:$T.gettext('Create new lecture'),meeting:$T.gettext('Create new meeting'),conference:$T.gettext('Create new conference')}[eventType];var url=match[2]!==undefined?build_url(Indico.Urls.EventCreation,{event_type:eventType,category_id:categoryId}):build_url(Indico.Urls.EventCreation,{event_type:eventType});ajaxDialog({url:url,title:title});}});(function(global){'use strict';$(document).ready(function(){setupActionLinks();setupAjaxForms();setupConfirmPopup();setupMathJax();setupSelectAllNone();setupAnchorLinks();setupToggleLinks();});global.getParamsFromSelectors=function getParamsFromSelectors(){var fieldParams={};_.each(arguments,function(selector){$(selector).each(function(){if(!(this.name in fieldParams)){fieldParams[this.name]=[];}
fieldParams[this.name].push($(this).val());});});return fieldParams;};global.getFormParams=function getFormParams($form){return getParamsFromSelectors($form.find('input[type=text]:not(:disabled), input[type=time]:not(:disabled), \
                                                  input[type=number]:not(:disabled), input[type=hidden]:not(:disabled), \
                                                  input:checked:not(:disabled), textarea:not(:disabled), \
                                                  select:not(:disabled)'));};function setupSelectAllNone(){$('body').on('click','[data-select-all]',function(){var selector=$(this).data('select-all');$(selector).filter(':not(:checked)').prop('checked',true).trigger('change');});$('body').on('click','[data-select-none]',function(){var selector=$(this).data('select-none');$(selector).filter(':checked').prop('checked',false).trigger('change');});}
function setupConfirmPopup(){$('body').on('click','[data-confirm]:not(button[data-href]):not(input:button[data-href]):not(a[data-method][data-href]):not(a[data-ajax-dialog][data-href])',function(){var $this=$(this);function performAction(){var evt=$.Event('indico:confirmed');$this.trigger(evt);if(evt.isDefaultPrevented()){return;}
if($this.is('form')){$this.submit();}else{window.location=$this.attr('href');}}
var evtBefore=$.Event('indico:beforeConfirmed');$this.trigger(evtBefore);if(evtBefore.isDefaultPrevented()){performAction();}else{confirmPrompt($(this).data('confirm'),$(this).data('title')).then(performAction);}
return false;});}
function setupActionLinks(){var selectors=['button[data-href][data-method]','input:button[data-href][data-method]','a[data-href][data-method]','button[data-href][data-ajax-dialog]','input:button[data-href][data-ajax-dialog]','a[data-href][data-ajax-dialog]','button[data-content][data-ajax-dialog]','input:button[data-content][data-ajax-dialog]','a[data-content][data-ajax-dialog]'];$('body').on('click',selectors.join(', '),function(e){e.preventDefault();var $this=$(this);if($this.hasClass('disabled')){return;}
var url=$this.data('href');var method=($this.data('method')||'GET').toUpperCase();var params=$this.data('params')||{};var paramsSelector=$this.data('params-selector');var update=$this.data('update');var ajax=$this.data('ajax')!==undefined;var replaceUpdate=$this.data('replace-update')!==undefined;var highlightUpdate=$this.data('highlight-update')!==undefined;var dialog=$this.data('ajax-dialog')!==undefined;var reload=$this.data('reload-after');var redirect=$this.data('redirect-after');var content=$this.data('content');if(!$.isPlainObject(params)){throw new Error('Invalid params. Must be valid JSON if set.');}
if(paramsSelector){params=$.extend({},getParamsFromSelectors(paramsSelector),params);}
function execute(){var evt=$.Event('indico:confirmed');$this.trigger(evt);if(evt.isDefaultPrevented()){return;}
if(dialog){var closeButton=$this.data('close-button');ajaxDialog({trigger:$this,url:url,method:method,data:params,content:$(content).html(),title:$this.data('title'),subtitle:$this.data('subtitle'),closeButton:closeButton===undefined?false:(closeButton||true),dialogClasses:$this.data('dialog-classes'),hidePageHeader:$this.data('hide-page-header')!==undefined,confirmCloseUnsaved:$this.data('confirm-close-unsaved')!==undefined,onClose:function(data,customData){if(data){handleFlashes(data,true,$this);if(update){updateHtml(update,data,replaceUpdate,highlightUpdate);}else if(reload!==undefined&&reload!=='customData'){IndicoUI.Dialogs.Util.progress();location.reload();}else if(redirect!==undefined){IndicoUI.Dialogs.Util.progress();location.href=redirect;}}else if(reload==='customData'&&customData){IndicoUI.Dialogs.Util.progress();location.reload();}}});return;}
if(ajax||update||reload!==undefined||redirect!==undefined){$.ajax({method:method,url:url,data:params,error:handleAjaxError,complete:IndicoUI.Dialogs.Util.progress(),success:function(data){var successEvt=$.Event('declarative:success');$this.trigger(successEvt,[data]);if(successEvt.isDefaultPrevented()){return;}
if(update){handleFlashes(data,true,$this);updateHtml(update,data,replaceUpdate,highlightUpdate);}else if(reload!==undefined){IndicoUI.Dialogs.Util.progress();location.reload();}else if(redirect!==undefined){IndicoUI.Dialogs.Util.progress();location.href=redirect;}else if(data.redirect){if(!data.redirect_no_loading){IndicoUI.Dialogs.Util.progress();}
location.href=data.redirect;}}});return;}
if(method==='GET'){location.href=build_url(url,params);}else if(method==='POST'){var form=$('<form>',{action:url,method:method});form.append($('<input>',{type:'hidden',name:'csrf_token',value:$('#csrf-token').attr('content')}));$.each(params,function(key,value){form.append($('<input>',{type:'hidden',name:key,value:value}));});form.appendTo('body').submit();}}
var promptMsg=$this.data('confirm');var confirmed;if(!promptMsg){confirmed=$.Deferred().resolve();}else{confirmed=confirmPrompt(promptMsg,$(this).data('title')||$T('Confirm action'));}
confirmed.then(execute);});}
function setupAjaxForms(){function _getOptions($elem,extra){var updateOpts=$elem.data('update');return $.extend({context:$elem,formContainer:$elem.data('form-container'),confirmCloseUnsaved:$elem.data('confirm-close-unsaved')!==undefined,update:updateOpts?{element:$elem.data('update'),replace:$elem.data('replace-update')!==undefined,highlight:$elem.data('highlight-update')!==undefined}:null},extra);}
function _handleClick(evt){evt.preventDefault();var $this=$(this);if($this.hasClass('disabled')){return;}
inlineAjaxForm(_getOptions($this,{load:{url:$this.data('href')},scrollToForm:$this.data('scroll-to-form')!==undefined}));function toggleDisabled(disabled){if($this.data('hide-trigger')!==undefined){$this.toggle(!disabled);}
if($this.is('a')){$this.toggleClass('disabled',disabled);}else{$this.prop('disabled',disabled);}
if(disabled){$this.trigger('indico:closeAutoTooltip');}}
$this.on('ajaxForm:show',function(){toggleDisabled(true);}).on('ajaxForm:hide',function(){toggleDisabled(false);});}
function _handleHtmlUpdate($elem){$elem.find('form[data-ajax-form]').each(function(){var $this=$(this);inlineAjaxForm(_getOptions($this,{load:null,initiallyHidden:$this.data('initially-hidden')!==undefined}));});}
$('body').on('click','button[data-ajax-form], a[data-ajax-form]',_handleClick);$('body').on('indico:htmlUpdated',function(evt){_handleHtmlUpdate($(evt.target));});_handleHtmlUpdate($('body'));}
function setupMathJax(){var $elems=$('.js-mathjax');if($elems.length){$elems.mathJax();}}
function setupAnchorLinks(){$('[data-anchor]').each(function(){var $elem=$(this);var fragment=$elem.data('anchor');$('<a>',{class:'anchor-link',href:'#'+fragment,title:$elem.data('anchor-text')||$T.gettext('Direct link to this item')}).html('&para;').appendTo($elem);});}
function setupToggleLinks(){$('body').on('click','[data-toggle]:not([data-toggle=dropdown])',function(evt){evt.preventDefault();var $elem=$(this);var accordion=$elem.data('accordion');var toggleClass=$elem.data('toggle-class');var isVisible=$elem.hasClass('js-details-visible');function toggleDetails($trigger){var $target=$($trigger.data('toggle'));var wasVisible=$trigger.hasClass('js-details-visible');$target.slideToggle('fast');$trigger.toggleClass('js-details-visible');if(toggleClass){$(toggleClass.target).toggleClass(toggleClass.class);}
$trigger.text(wasVisible?$trigger.data('show-text'):$trigger.data('hide-text'));}
if(!isVisible&&accordion!==undefined){$(accordion).find('.js-details-visible').each(function(){toggleDetails($(this));});}
toggleDetails($elem);});}})(window);(function(global){'use strict';global.handleAjaxError=function handleAjaxError(data){if('responseText'in data&&data.readyState===0&&data.status===0&&!data.responseText){return true;}
if(data.responseText){try{data=JSON.parse(data.responseText);}catch(e){showErrorDialog({title:$T.gettext('Something went wrong'),message:'{0} ({1})'.format(data.statusText.toLowerCase(),data.status),suggest_login:false,report_url:null});return true;}}
var error=data.error||(data.data&&data.data.error);if(error){showErrorDialog(error);return true;}};global.showFormErrors=function showFormErrors(context){context=context||$('body');context.find(".i-form .has-error > .form-field, .i-form .has-error > .form-subfield").each(function(){var $this=$(this);var input=$this.find('[data-tooltip-anchor]');if(!input.length){input=$this.children(':input:not(:hidden)').eq(0);}
if(!input.length){input=$this.children(':not(:input:hidden)').eq(0);}
input.stickyTooltip('danger',function(){return $this.data('error');});});};})(window);(function($){'use strict';$.fn.ajaxCheckbox=function ajaxCheckbox(options){options=$.extend({sendData:true,method:null,href:null},options);function getOption(opt,ctx){var value=options[opt];if(_.isFunction(value)){return value.call(ctx);}else{return value;}}
return this.on('click',function(e){e.preventDefault();var self=this;var $this=$(this);var checked=this.checked;var message=checked?$this.data('confirm_enable'):$this.data('confirm_disable');var deferred=message?confirmPrompt(message):$.Deferred().resolve();deferred.then(function(){$this.prop('checked',checked).prop('disabled',true);var data=options.sendData?{enabled:checked?'1':'0'}:null;$.ajax({url:getOption('href',self)||$this.data('href'),method:getOption('method',self)||$this.data('method')||'POST',dataType:'json',data:data,complete:function(){$this.prop('disabled',false);},error:function(data){handleAjaxError(data);$this.prop('checked',!checked);},success:function(data){$this.prop('checked',data.enabled).trigger('ajaxCheckbox:changed',[data.enabled,data]);handleFlashes(data,true,$this);}});});});};})(jQuery);(function(global,$){'use strict';$.fn.ajaxDialog=function jqAjaxDialog(options){return this.on('click',function(e){e.preventDefault();if($(this).hasClass('disabled')){return;}
var href=$(this).attr('href');if(href===undefined||href==='#'){var dataHref=$(this).data('href');href=dataHref?dataHref:href;}
ajaxDialog($.extend({title:$(this).data('title')},options,{url:href,trigger:this}));});};global.ajaxDialog=function ajaxDialog(options){options=$.extend({trigger:null,title:null,subtitle:null,closeButton:undefined,url:null,content:null,method:'GET',data:null,backSelector:'[data-button-back]',clearFlashes:true,onClose:null,onOpen:null,onLoadError:null,onError:null,getExtraData:function(){},confirmCloseUnsaved:false,dialogClasses:'',hidePageHeader:false,fullyModal:false},options);var confirmCloseMessage=$T('You have unsaved changes. Do you really want to close the dialog without saving?');var popup=null;var customData=null;var oldOnBeforeUnload=null;var ignoreOnBeforeUnload=false;loadDialog();function loadDialog(){if(options.content){showDialog({js:'',html:options.content});return;}
$.ajax({type:options.method,url:options.url,data:$.isFunction(options.data)?options.data():options.data,cache:false,complete:IndicoUI.Dialogs.Util.progress(),error:function(xhr){var handled=false;if(options.onLoadError&&options.onLoadError(xhr)===false){handled=true;}
if(options.trigger){var evt=$.Event('ajaxDialog:loadError');$(options.trigger).trigger(evt,[xhr]);if(evt.isDefaultPrevented()){handled=true;}}
if(!handled){handleAjaxError(xhr);}},success:function(data,_,xhr){if(handleAjaxError(data)){return;}
var loadedURL=xhr.getResponseHeader('X-Indico-URL');if(loadedURL){options.url=loadedURL.replace(/&_=\d+/,'').replace(/\?_=\d+$/,'').replace(/\?_=\d+&/,'?');}
showDialog(data);}});}
function hasChangedFields(){var forms=popup.contentContainer.find('form');return forms.length&&!!forms.filter(function(){return $(this).data('fieldsChanged');}).length;}
function confirmClose(){return hasChangedFields()?confirmPrompt(confirmCloseMessage,$T('Unsaved changes')):$.Deferred().resolve();}
function showDialog(dialogData){if(popup){_doCloseDialog();}
popup=new ExclusivePopup($.isFunction(options.title)?options.title.call(options.trigger):options.title,function(){closeDialog(null);return false;},false,false);popup.draw=function(){if(options.trigger&&$(options.trigger).closest('.event-locked').length){this.canvas.addClass('event-locked');}
this.ExclusivePopup.prototype.draw.call(this,dialogData.html);if(options.subtitle){this.canvas.prepend($('<div>',{class:'dialog-subtitle',text:options.subtitle}));}
if(options.closeButton!==undefined&&options.closeButton!==false){var text=options.closeButton===true?$T.gettext("Close"):options.closeButton;this.contentContainer.append($('<button>',{'class':'i-button big right','type':'button','text':text,'data-button-back':''}));}};popup.postDraw=function(){ajaxifyForms();popup.canvas.on('ajaxDialog:setData',function(e,data){customData=data;});popup.canvas.on('ajaxDialog:close',function(e,data,submitted){closeDialog(data,submitted);});popup.canvas.on('ajaxDialog:reload',function(){loadDialog();});injectJS(dialogData.js);_onOpen();_.defer(function(){popup.canvas.focusFirstField();});return true;};var dialogClasses=_.union(['dialog-window',options.dialogClasses]);if(options.hidePageHeader){dialogClasses.push('no-page-header');}
popup.canvas.addClass(dialogClasses.join(' '));if(options.confirmCloseUnsaved){oldOnBeforeUnload=window.onbeforeunload;window.onbeforeunload=function(){if(popup.isopen&&!ignoreOnBeforeUnload&&hasChangedFields()){return confirmCloseMessage;}};}
popup.open();}
function closeDialog(callbackData,submitted){var confirmDeferred=(submitted||!options.confirmCloseUnsaved)?$.Deferred().resolve():confirmClose();confirmDeferred.then(function(){ignoreOnBeforeUnload=true;var onCloseResult=_onClose(callbackData);if(onCloseResult===false){ignoreOnBeforeUnload=false;return;}else if(!onCloseResult||onCloseResult===true){onCloseResult=$.Deferred().resolve();}
onCloseResult.then(function(){_doCloseDialog();if(options.trigger){$(options.trigger).trigger('ajaxDialog:closed',[callbackData,customData]);}},function(){ignoreOnBeforeUnload=false;});});}
function _doCloseDialog(){popup.close();if(options.confirmCloseUnsaved){window.onbeforeunload=oldOnBeforeUnload;}
popup=null;}
function _onOpen(){if(options.fullyModal){$('html, body').addClass('prevent-scrolling');}
if(options.onOpen){options.onOpen(popup);}}
function _onClose(callbackData){if(options.fullyModal){$('html, body').removeClass('prevent-scrolling');}
if(!options.onClose){return $.Deferred().resolve();}else{return options.onClose(callbackData,customData);}}
function ajaxifyForms(){var killProgress=null;popup.contentContainer.on('click',options.backSelector,function(e){e.preventDefault();closeDialog();});var forms=popup.contentContainer.find('form');showFormErrors(popup.resultContainer);initForms(forms);forms.filter(':not([data-no-ajax])').each(function(){var $this=$(this);$this.on('ajaxForm:beforeSubmit',function(){killProgress=IndicoUI.Dialogs.Util.progress();}).on('ajaxForm:error',function(e,xhr){if(killProgress){killProgress();}
e.preventDefault();if($.isFunction(options.onError)){options.onError.call($this,xhr);}else{handleAjaxError(xhr);}}).on('ajaxForm:success',function(e,data){if(killProgress){killProgress();}
if(handleAjaxError(data)){return;}
handleFlashes(data,options.clearFlashes,options.trigger?$(options.trigger):null);if(data.close_dialog||data.success){closeDialog(data,true);if(data.redirect){if(!data.redirect_no_loading){IndicoUI.Dialogs.Util.progress();}
location.href=data.redirect;}}else if(data.html){popup.contentContainer.html(data.html);ajaxifyForms();injectJS(data.js);}});var action=$this.attr('action')||options.url;$this.ajaxForm({url:action,dataType:'json',data:options.getExtraData.call(this,options.trigger),beforeSubmit:function(){var evt=$.Event('ajaxForm:validateBeforeSubmit');$this.trigger(evt);if(evt.isDefaultPrevented()){return false;}
$this.trigger('ajaxForm:beforeSubmit');},error:function(xhr){$this.trigger('ajaxForm:error',[xhr]);},success:function(data){$this.trigger('ajaxForm:success',[data]);}});});}
function injectJS(js){if(js){$('body').append(js);}}};})(window,jQuery);(function(global){'use strict';global.inlineAjaxForm=function inlineAjaxForm(options){options=$.extend(true,{context:null,trigger:null,load:{url:null,method:'GET',data:{}},initiallyHidden:false,scrollToForm:false,formContainer:null,closeSelector:'[data-button-back]',confirmCloseUnsaved:false,update:{element:null,replace:false,highlight:false}},options);var formUrl=options.load?options.load.url:location.href;var formContainer=$(options.formContainer);var formVisible=false;var oldContent=null;var savedFiles={};var context=options.context?$(options.context):null;function triggerEvent(name){if(!context){return false;}
var evt=$.Event(name);context.trigger(evt,[].slice.call(arguments,1));return evt.isDefaultPrevented();}
function updateFormUrl(xhr){var loadedUrl=xhr.getResponseHeader('X-Indico-URL');if(loadedUrl){formUrl=loadedUrl.replace(/&_=\d+/,'').replace(/\?_=\d+$/,'').replace(/\?_=\d+&/,'?');}}
function loadForm(){$.ajax({url:options.load.url,method:options.load.method,data:options.load.data,cache:false,dataType:'json',complete:IndicoUI.Dialogs.Util.progress(),error:function(xhr){if(!triggerEvent('ajaxForm:loadError',xhr)){handleAjaxError(xhr);}},success:function(data,_,xhr){updateFormUrl(xhr);showForm(data);}});}
function showForm(data){var triggerShow=false;if(!formVisible){oldContent=formContainer.contents().detach();formVisible=true;triggerShow=true;if(options.confirmCloseUnsaved){$(window).on('beforeunload',onBeforeUnload);}}
formContainer.html(data.html);formContainer.find(options.closeSelector).on('click',function(evt){evt.preventDefault();var msg;if(options.confirmCloseUnsaved&&(msg=onBeforeUnload())!==undefined){confirmPrompt(msg,$T.gettext('Unsaved changes')).then(hideForm);}else{hideForm();}});ajaxifyForms();if(data.js){$('body').append(data.js);}
if(triggerShow){triggerEvent('ajaxForm:show');if(options.scrollToForm){$('body, html').animate({scrollTop:formContainer.offset().top});}}
_.defer(function(){formContainer.focusFirstField();});}
function hideForm(){if(options.confirmCloseUnsaved){$(window).off('beforeunload',onBeforeUnload);}
if(!formVisible||!options.load){return;}
formVisible=false;formContainer.html(oldContent);oldContent=null;triggerEvent('ajaxForm:hide');}
function _bindEvents($form){var killProgress;$form.on('ajaxForm:beforeSubmit',function(){killProgress=IndicoUI.Dialogs.Util.progress();$.extend(savedFiles,getDropzoneFiles($form));}).on('ajaxForm:error',function(evt,xhr){if(killProgress){killProgress();}
evt.preventDefault();handleAjaxError(xhr);}).on('ajaxForm:success',function(evt,data){if(killProgress){killProgress();}
if(data.success){savedFiles={};hideForm();var updateOpts=options.update;if(updateOpts){updateHtml(updateOpts.element,data,updateOpts.replace,updateOpts.highlight);}else if(data.redirect){if(!data.redirect_no_loading){IndicoUI.Dialogs.Util.progress();}
location.href=data.redirect;}}else if(data.html){showForm(data);$.each(savedFiles,function(id,files){setDropzoneFiles($('#'+id),files);});savedFiles={};}});}
function ajaxifyForms(noInit){var forms=formContainer.find('form');if(!noInit){showFormErrors(formContainer);initForms(forms);}
forms.each(function(){var $this=$(this);_bindEvents($this);$this.ajaxForm(_getAjaxFormArgs($this));});}
function _getAjaxFormArgs($form){return{url:$form.attr('action')||formUrl,dataType:'json',beforeSubmit:function(){if($form.data('dropzoneField')){return false;}
var evt=$.Event('ajaxForm:validateBeforeSubmit');$form.trigger(evt);if(evt.isDefaultPrevented()){return false;}
$form.trigger('ajaxForm:beforeSubmit');},error:function(xhr){$form.trigger('ajaxForm:error',[xhr]);},success:function(data){$form.trigger('ajaxForm:success',[data]);}};}
function hasChangedFields(){var forms=formContainer.find('form');return!!forms.length&&!!forms.filter(function(){return $(this).data('fieldsChanged');}).length;}
function onBeforeUnload(){if(hasChangedFields()){return $T.gettext('You have unsaved changes that will be lost.');}}
if(context){context.on('ajaxForm:externalShow',function(){if(options.confirmCloseUnsaved){$(window).on('beforeunload',onBeforeUnload);}});context.on('ajaxForm:externalHide',function(evt,deferred){var msg;if(!options.confirmCloseUnsaved){deferred.resolve();}else if((msg=onBeforeUnload())===undefined){deferred.resolve();}else{confirmPrompt(msg,$T.gettext('Unsaved changes')).then(function(){deferred.resolve();},function(){deferred.reject();});}
if(options.confirmCloseUnsaved){deferred.then(function(){$(window).off('beforeunload',onBeforeUnload);});}});}
if(!options.load){if(options.confirmCloseUnsaved&&!options.initiallyHidden){$(window).on('beforeunload',onBeforeUnload);}
ajaxifyForms(true);}else if(options.trigger){options.trigger.on('click',function(evt){evt.preventDefault();loadForm();});}else{loadForm();}};})(window);(function($){'use strict';$.widget("indico.clearableinput",{options:{alwaysClearable:false,clearClass:'clearableinput',clearOnEscape:true,emptyvalue:'',focusOnClear:true,focusOnStart:false,onClear:function(){},onInput:function(){}},_create:function(){var self=this;self.buttonBox=$('<span>').addClass('button-box');self.clearIcon=$('<a>').addClass('i-link danger icon-close').css('line-height',self.element.outerHeight()+'px').click(function(evt){self._clear();evt.stopPropagation();});var display=self.element.css('display');var wrapper=$('<span>').css('display',display).addClass(self.options.clearClass);self.element.addClass('clearabletext').wrap(wrapper).on('input',function(){self._handleInput();}).on('keyup',function(e){if(self.options.clearOnEscape){if(e.which===K.ESCAPE){self.element.val('value');self._clear();}}});self.buttonBox.append(self.clearIcon);self.element.after(self.buttonBox);self._refreshClearIcon();if(self.options.focusOnStart){self.element.focus();}},_clear:function(){var self=this;self.element.val(self.options.emptyvalue).trigger('propertychange').trigger('change');self._refreshClearIcon();self.options.onClear.call(self.element);if(self.options.focusOnClear){self.element.focus();}else{self.element.blur();}},_handleInput:function(){var self=this;self.options.onInput.call(self.element);self._refreshClearIcon();},_refreshClearIcon:function(){var self=this;if(self.element.val()===self.options.emptyvalue&&!self.options.alwaysClearable){self.clearIcon.css('visibility','hidden');}else{self.clearIcon.css('visibility','visible');}},initSize:function(fontSize,lineHeight){var self=this;if(self.size===undefined){self.size={fontSize:fontSize,lineHeight:lineHeight};}
self.clearIcon.css('font-size',self.size.fontSize);self.clearIcon.css('line-height',self.size.lineHeight);self.element.css('min-height',self.size.lineHeight);},setEmptyValue:function(value){var self=this;self.options.emptyvalue=value;},setValue:function(value){var self=this;self.element.val(value);self._refreshClearIcon();},setIconsVisibility:function(visibility){var self=this;self.clearIcon.css('visibility',visibility);}});})(jQuery);(function($){'use strict';$.widget('indico.dropdown',{options:{selector:'.i-button[data-toggle]',effect_on:'slideDown',effect_off:'fadeOut',time_on:200,time_off:200,positioning:{},relative_to:undefined,always_listen:false},_close:function(elem,effect){var ul=elem.next('ul');elem.removeClass('open');elem.removeData('no-auto-tooltip');this._effect('off',ul,effect);ul.find('ul').hide();elem.data('on',false);elem.parent().removeClass('selected');elem.siblings('ul').find('a').data('on',false);},_close_all:function(effect){var self=this;this.element.find('a, button').each(function(){self._close($(this),effect);});},_open:function(elem){var self=this;var sibl=elem.next('ul.dropdown');var positionReference=this.options.relative_to||elem;elem.addClass('open');elem.data('no-auto-tooltip',true).trigger('indico:closeAutoTooltip');this._effect('on',sibl);elem.data('on',true);elem.parent().addClass('selected');sibl.position($.extend({of:positionReference},this.options.positioning[sibl.data('level')]||{my:'left top',at:'left bottom',offset:'0px 0px'}));this.element.find('a').each(function(){if(this!==elem.get(0)){self._close($(this));}});},_menuize:function(elem){var self=this;elem.find(this.options.selector).each(function(){var $this=$(this);if(!$this.attr('href')||$this.attr('href')==="#"||$this.data('ignore-href')!==undefined||self.options.always_listen){$this.click(function(e){if($this.data('toggle')==='dropdown'){if($this.data('on')){self._close($this);}else if(!$this.hasClass('disabled')){self._open($this);}
e.preventDefault();}else{var result=$this.triggerHandler('menu_select',self.element);if(!result){self._close_all();}
e.preventDefault();}});}});elem.find('ul.dropdown > li > a').each(function(){var $this=$(this);if(!$this.attr('href')||$this.attr('href')==="#"||$this.data('ignore-href')!==undefined||self.options.always_listen){$this.click(function(e){e.preventDefault();if($this.hasClass('disabled')){return;}
var result=$this.triggerHandler('menu_select',self.element);if(!result){self._close_all();}});}});elem.find('ul.dropdown > li.toggle').each(function(){var li=$(this);var link=$('<a>',{href:'#',text:li.text(),class:'icon-checkmark '+(li.data('state')?'':'inactive'),click:function(e){e.preventDefault();var $this=$(this);var newState=!li.data('state');$this.toggleClass('inactive',!newState);li.data('state',newState);li.triggerHandler('menu_toggle',[newState]);}});li.html(link);});},_create:function(){var self=this;this._menuize(this.element);$(document).on('click',function(e){if($(self.element).has(e.target).length===0){self._close_all();}});},_effect:function(st,elem,effect){var func=effect===undefined?this.options['effect_'+st]:effect;if(func===null){elem.hide();}else if(typeof func=='function'){func.call(elem,this);}else{elem[func].call(elem,this.options['time_'+st]);}},close:function(){this._close_all(null);}});})(jQuery);(function($){'use strict';$.widget('indico.actioninput',$.indico.clearableinput,{options:{actionCallback:function(){},actionIcon:'icon-checkmark',alwaysClearable:true,enterKeyEnabled:true},_create:function(){var self=this;var input=self.element;self._super();self.actionIcon=$('<a class="i-link accept hide-if-locked {0}"></a>'.format(self.options.actionIcon)).css("line-height",input.css("height")).click(function(){self._action();});input.on("keydown keypress",function(e){if(e.which===K.ENTER&&self.options.enterKeyEnabled){self._action();}});self.buttonBox.prepend(self.actionIcon);input.addClass('actionabletext');},_action:function(){var self=this;var opt=self.options;var input=self.element;opt.actionCallback();if(opt.focusOnClear){input.focus();}else{input.blur();}},initSize:function(fontSize,lineHeight){var self=this;self._super(fontSize,lineHeight);self.actionIcon.css('font-size',self.size.fontSize);self.actionIcon.css('line-height',self.size.lineHeight);},setIconsVisibility:function(visibility){var self=this;self._super(visibility);self.actionIcon.css('visibility',visibility);}});})(jQuery);(function($){$.widget("indico.multitextfield",{options:{fieldsCaption:"field",parameterManager:undefined,parameterType:"text",sortable:false,valueField:undefined,fieldName:undefined},_create:function(){this.info=[];this.valueField=this.options.valueField;this.fieldName=this.options.fieldName;if(this.valueField){this.field=this.valueField;this.data=this.field.val()?JSON.parse(this.field.val()):[];}
this.element.addClass("multi-text-fields");this._createList();this._handleEvents();this._drawList();},destroy:function(){this.element.off("focusout click keyup propertychange paste");this.element.removeClass("multi-text-fields");this.list.remove();},_createList:function(){var self=this;self.list=$("<ul></ul>");self.element.append(self.list);if(self.options.sortable){self.list.sortable({axis:"y",containment:"parent",cursor:"move",distance:10,handle:".handle",items:"li:not(:last-child)",tolerance:"pointer",start:function(e,ui){self.start_index=ui.item.index();ui.item.find("input").blur();},update:function(e,ui){_.move(self.info,self.start_index,ui.item.index());if(self.valueField){_.move(self.data,self.start_index,ui.item.index());self._updateValueField(self.data);}}});}},_handleEvents:function(){var self=this;self.element.on("focusout","input",function(){self._updateField(this);self._drawNewItem();});self.element.on("click","a",function(e){e.preventDefault();self._deleteItem($(this).closest("li"));});self.element.on("keyup propertychange paste input","input",function(e){if(e.type=="keyup"&&e.which==13){$(this).blur();$(this).parent().next().find("input").focus();}
if(self.valueField&&$(this).val().trim()){var oldDataItem=self.data[$(this).parent().index()];self.data[$(this).parent().index()]=self._updateDataItem($(this).val(),oldDataItem);self._updateValueField(self.data);}
if($(this).val()===""&&!$(this).prop('required')){self._deleteNewItem($(this).closest("li"));}
self._drawNewItem();});self.element.on("keydown","input",function(e){if(e.which==27){e.stopPropagation();var value=self._getField($(this).data("id")).value;$(this).val(value);$(this).blur();$(this).trigger("propertychange");}});},_drawList:function(){var i=0;var self=this;var list=self.list;self._reinitList();if(self.valueField){for(i=0;i<self.data.length;++i){var obj={id:i,value:self.data[i][self.fieldName],required:true};list.append(self._item(obj));self.info[i]=obj;}}
else{for(i=0;i<self.info.length;++i){list.append(self._item(self.info[i]));}}
self._drawNewItem();},_reinitList:function(){this.next_id=-1;this.new_item=undefined;this.list.find("li").each(function(){$(this).remove();});},_drawNewItem:function(){if(this.new_item===undefined||this.new_item.find("input").val()!==""){this.new_item=this._item(this._addNewFieldInfo());this.list.append(this.new_item);this.element.scrollTop(this.element[0].scrollHeight);this._scrollFix();}},_deleteNewItem:function(item){if(item.next()[0]==this.new_item[0]){if(this.valueField){this.data.splice(item.index(),1);this._updateValueField(this.data);}
this._deleteNewFieldInfo();this.new_item.remove();this.new_item=item;this._removeFieldFromPM(item.find("input"));this._scrollFix();}},_deleteItem:function(item){if(item[0]!=this.new_item[0]){if(this.valueField){this.data.splice(item.index(),1);this._updateValueField(this.data);}
var id=item.find("input").data("id");var index=this._getFieldIndex(id);this.info.splice(index,1);this._removeFieldFromPM(item.find("input"));item.remove();this._scrollFix();}},_addNewFieldInfo:function(){var id=this._nextId();var field={"id":id,"value":""};this.info.push(field);return field;},_deleteNewFieldInfo:function(){this._prevId();this.info.pop();},_getField:function(id){for(var i=0;i<this.info.length;++i){if(this.info[i]["id"]==id){return this.info[i];}}
return undefined;},_getFieldIndex:function(id){for(var i=0;i<this.info.length;++i){if(this.info[i]["id"]==id){return i;}}
return undefined;},_addFieldToPM:function(input){if(this.options.parameterManager!==undefined){var parameterType=this.options.parameterType;this.options.parameterManager.remove(input);this.options.parameterManager.add(input,parameterType,false);}},_removeFieldFromPM:function(input){if(this.options.parameterManager!==undefined){this.options.parameterManager.remove(input);}},_item:function(field){field=field||this._addNewFieldInfo();var id=field["id"];var value=field["value"];var placeholder=field.required?'':$T.gettext('Type to add {0}').format(this.options.fieldsCaption);var item=$("<li></li>");if(this.options.sortable){item.append($("<span class='handle'></span>"));}
var newInput=$('<input>',{type:'text',required:field.required,data:{id:id},value:value,placeholder:placeholder});this._validateValue(newInput);item.append(newInput);item.append($('<a>',{class:'i-button-remove icon-remove',title:$T("Delete"),href:'#',tabindex:'-1'}));item.find("a.i-button-remove").qtip({position:{at:"top center",my:"bottom center",target:item.find("a")},hide:{event:"mouseleave"}});return item;},_updateField:function(input){input=$(input);if(input.val()===""&&!input.prop('required')){var item=input.closest("li");this._deleteItem(item);}else{this._getField(input.data("id"))["value"]=input.val();this._addFieldToPM(input);}},_nextId:function(){return this.next_id--;},_prevId:function(){return this.next_id===0?this.next_id:this.next_id++;},_scrollFix:function(){if((this.element[0].clientHeight+1<this.element[0].scrollHeight)){this.element.find("input").addClass("width-scrolling");}else{this.element.find("input").removeClass("width-scrolling");}},getInfo:function(){return this.info.slice().splice(0,this.info.length-1);},setInfo:function(info){this.info=info;this._drawList();},_updateValueField:function(newData){this.field.val(JSON.stringify(newData)).trigger('change');this.data=newData;},_updateDataItem:function(value,oldDataItem){if(!oldDataItem){oldDataItem={};}
oldDataItem[this.fieldName]=value;return oldDataItem;},_validateValue:function(field){if('setCustomValidity'in field[0]){field.on('change input',function(){if(!field.val()||field.val().trim()){field[0].setCustomValidity('');}else{field[0].setCustomValidity($T('Empty values are not allowed.'));}});}}});})(jQuery);var oldcreate=$.ech.multiselect.prototype._create;$.extend($.ech.multiselect.prototype,{_create:function(){this.oldcreate=oldcreate;this.oldcreate(this);this._fixEventBindings();},_fixEventBindings:function(){this.header.delegate('input[type="checkbox"], input[type="radio"]','click.multiselect',function(e){e.stopPropagation();});this.menu.undelegate('label','mouseenter.multiselect');}});$.extend($.ech.multiselectfilter.prototype,{advancedFilter:function(searchText){this.searchText=searchText||"";this._handler(this);},_checkOptions:function(label){var searchValues=this.searchText.split(':');var fieldValues=label.split(':');for(var i=0;i<searchValues.length;i++){if(searchValues[i]&&((!isNaN(fieldValues[i])&&parseInt(searchValues[i])>parseInt(fieldValues[i]))||fieldValues[i]=="None"))
return false;if(searchValues[i].toLowerCase()=="true"&&fieldValues[i].toLowerCase()=="false")
return false;}
return true;},updateCache:function(){this.rows=this.instance.menu.find(".ui-multiselect-checkboxes li:not(.ui-multiselect-optgroup-label)");this.cache=this.element.children().map(function(){var self=$(this);if(this.tagName.toLowerCase()==="optgroup"){self=self.children();}
return self.map(function(){return this.innerHTML.toLowerCase();}).get();}).get();this.cache2=this.element.children().map(function(){var self=$(this);if(this.tagName.toLowerCase()==="optgroup"){self=self.children();}
return self.map(function(){return $(this).attr('label');}).get();}).get();},_handler:function(e){var rEscape=/[\-\[\]{}()*+?.,\\\^$|#\s]/g;var self=this;var term=$.trim(this.input[0].value.toLowerCase()),rows=this.rows,inputs=this.inputs,cache=this.cache;if(!term&&!this.searchText){rows.show();}else{rows.hide();var regex=new RegExp(term.replace(rEscape,"\\$&"),'gi');this._trigger("filter",e,$.map(cache,function(v,i){if(v.search(regex)!==-1&&self._checkOptions(self.cache2[i])){rows.eq(i).show();return inputs.get(i);}
return null;}));}
this.instance.menu.find(".ui-multiselect-optgroup-label").each(function(){var $this=$(this);var isVisible=$this.nextUntil('.ui-multiselect-optgroup-label').filter(function(){return $.css(this,"display")!=='none';}).length;$this[isVisible?'show':'hide']();});}});(function($){'use strict';function getUserId(obj){if(obj._type==='Avatar'){return obj.id;}else if(obj._type==='EventPerson'){return obj.user_id;}}
function comparePersons(a,b){var aUserId=getUserId(a);var bUserId=getUserId(b);if(a._type===b._type&&a.id!==undefined&&b.id!==undefined&&a.id===b.id){return true;}
if(aUserId!==undefined&&bUserId!==undefined&&aUserId===bUserId){return true;}
return!!a.email&&!!b.email&&a.email.toLowerCase()===b.email.toLowerCase();}
$.widget('indico.principalfield',{options:{eventId:null,suggestedUsers:null,allowExternalUsers:true,allowEmptyEmail:false,enableGroupsTab:false,multiChoice:false,overwriteChoice:true,showFavoriteUsers:true,render:function(people){},onAdd:function(people){},onRemove:function(){}},_create:function _create(){var self=this;self.people=JSON.parse(self.element.val()||'[]');self.options.render(self.people);},_update:function _update(){var self=this;var people=self.people?JSON.stringify(self.people):'[]';self.element.val(people);self.element.trigger('change');self.options.render(self.people);},add:function add(people){var self=this;function deduplicate(people){var newPeople=[];people.forEach(function(person){var found=_.find(newPeople,function(newPerson){return comparePersons(person,newPerson);});if(!found){newPeople.push(person);}});return newPeople;}
function skipExisting(people){_.each(self.people,function(person){people=_.without(people,_.find(people,function(p){return comparePersons(person,p);}));});return people;}
people=deduplicate(people);self.people=self.options.overwriteChoice?people:self.people.concat(skipExisting(people));self.people=_.sortBy(self.people,'name');self.options.onAdd(self.people);self._update();},choose:function choose(){var self=this;function handle(people){self.add(people);}
var userChoosePopup=new ChooseUsersPopup($T("Choose person"),true,self.options.eventId,self.options.enableGroupsTab,self.options.showFavoriteUsers,self.options.suggestedUsers,!self.options.multiChoice,true,false,handle,null,self.options.allowExternalUsers);userChoosePopup.execute();},edit:function edit(personId){var self=this;var person=_.findWhere(self.people,{id:personId});function handle(person){self.set(person.get('id'),person.getAll());}
function checkEmail(person){person=person.getAll();var found=_.find(self.people,function(p){return person.id!==p.id&&comparePersons(person,p);});if(found){alertPopup($T.gettext('There is already another person with this email address.'),$T.gettext('Warning'));return false;}
return true;}
var personEditPopup=new UserDataPopup($T("Edit information"),$O(person),handle,false,false,false,self.options.allowEmptyEmail,true,checkEmail);personEditPopup.open();},enter:function enter(){var self=this;function handle(person){self.add([person.getAll()]);}
var personCreatePopup=new UserDataPopup($T("Enter person"),$O(),handle,false,false,false,self.options.allowEmptyEmail);personCreatePopup.open();},remove:function remove(){var self=this;self.people=[];self.options.onRemove();self._update();},removeOne:function removeOne(personId){var self=this;var person=_.findWhere(self.people,{id:personId});self.people=_.without(self.people,person);self._update();},set:function set(personId,data){var self=this;var person=_.findWhere(self.people,{id:personId});$.extend(person,data);self._update();},refresh:function refresh(){this._update();}});})(jQuery);(function($){$.widget('indico.qbubble',{defaultQtipOptions:{overwrite:true,suppress:false,position:{my:'top center',at:'bottom center',adjust:{mouse:false,scroll:false}},show:{event:'click',solo:true},hide:{event:'unfocus click'}},_create:function(){var self=this;var classes=self.options.style?self.options.style.classes:'';self.element.qtip($.extend(true,{},self.defaultQtipOptions,self.options,{style:{classes:'qbubble '+classes}}));this._on({click:function(evt){evt.preventDefault();}});},api:function(){var self=this;return self.element.qtip('api');},destroy:function(){var self=this;self.element.qtip('destroy');},hide:function(){var self=this;self.element.qtip('hide');},option:function(entry,value){var self=this;self.element.qtip('option',entry,value);},createNested:function(elem,nestedQtipOptions){var self=this;var originalHideCallback=nestedQtipOptions.events&&nestedQtipOptions.events.hide;var originalShowCallback=nestedQtipOptions.events&&nestedQtipOptions.events.show;$.extend(true,nestedQtipOptions,{events:{show:function(evt,api){if(originalShowCallback){originalShowCallback(evt,api);}
if(!evt.defaultPrevented){self._hasNestedOpen=true;self.element.qtip('disable');}},hide:function(evt,api){if(originalHideCallback){originalHideCallback(evt,api);}
if(!evt.defaultPrevented){self._hasNestedOpen=false;self.element.qtip('enable');}}}});elem.qbubble(nestedQtipOptions);}});})(jQuery);(function($){'use strict';$.widget('indico.ajaxqbubble',{options:{qBubbleOptions:{position:{effect:false},content:{text:$('<span>',{text:$T.gettext('Loading...')})}},url:null,method:'GET',cache:false,success:null,onClose:null,qtipConstructor:null},_create:function(){var self=this;var qBubbleOptions=_.pick(self.options,'qBubbleOptions').qBubbleOptions;var ajaxOptions=_.omit(self.options,'qBubbleOptions');var returnData=null;var options=$.extend(true,{},qBubbleOptions,{events:{show:function(evt,api){$.ajax($.extend(true,{},ajaxOptions,{complete:IndicoUI.Dialogs.Util.progress(),error:handleAjaxError,success:function(data,_,xhr){if($.isFunction(ajaxOptions.success)){ajaxOptions.success.call(self.element,data);}
var loadedURL=xhr.getResponseHeader('X-Indico-URL');if(loadedURL){loadedURL=loadedURL.replace(/&_=\d+/,'').replace(/\?_=\d+$/,'').replace(/\?_=\d+&/,'?');}
function updateContent(data){if(data){api.set('content.text',ajaxifyForm($(data.html).find('form').addBack('form')));if(data.js){$('body').append(data.js);}}}
function ajaxifyForm($form){initForms($form);var killProgress;return $form.ajaxForm({url:$form.attr('action')||loadedURL,method:'POST',error:handleAjaxError,beforeSubmit:function(){killProgress=IndicoUI.Dialogs.Util.progress();},complete:function(){killProgress();},success:function(data){if(data.success){self.element.next('.label').text(data.new_value);returnData=data;api.hide(true);}else{updateContent(data);showFormErrors($('#qtip-'+api.id+'-content'));}}});}
updateContent(data);}}));if(qBubbleOptions.events&&qBubbleOptions.events.show){qBubbleOptions.events.show(evt,api);}},hide:function(evt,api){var originalEvent=evt.originalEvent;if(self.options.onClose){self.options.onClose(returnData);}
returnData=null;if((originalEvent&&$(originalEvent.target).closest('#ui-datepicker-div').length)){return false;}
if(qBubbleOptions.events&&qBubbleOptions.events.hide){qBubbleOptions.events.hide(evt,api);}
return true;},hidden:function(evt,api){api.get('content.text').remove();if(qBubbleOptions.events&&qBubbleOptions.events.hidden){qBubbleOptions.events.hidden(evt,api);}}}});if(self.options.qtipConstructor){self.options.qtipConstructor(self.element,options);}else{self.element.qbubble(options);}}});})(jQuery);(function($){$.widget("indico.realtimefilter",{options:{callback:function(value){},validation:function(e){return true;},clearable:true,disableenter:true,emptyvalue:"",invalidclass:'invalid',wait:250},_create:function(){var self=this;var element=self.element;var opt=self.options;element.typeWatch({callback:function(){self._callback();},wait:opt.wait,highlight:false,captureLength:0});if(opt.clearable){element.clearableinput({onClear:function(){self._callback();},emptyvalue:opt.emptyvalue});}
element.on('cut paste',function(){self._delayedCallback();});element.on('focusout',function(){if($(this).val()===""){$(this).val(opt.emptyvalue);}});if(opt.disableenter){element.on('keydown',function(e){if(e.which==K.ENTER){e.preventDefault();}});}},_callback:function(){var self=this;var element=self.element;var opt=self.options;if(opt.validation(element)){element.removeClass(opt.invalidclass);opt.callback(element.val().trim());}else{element.addClass(opt.invalidclass);}},_delayedCallback:function(){var self=this;setTimeout(function(){self._callback();},self.options.wait);},clear:function(){var self=this;self.setValue('');},setValue:function(value){var self=this;if(self.options.clearable){self.element.clearableinput('setValue',value);}else{self.element.val(value);}
self.element.trigger('input');},update:function(delayed){var self=this;if(delayed){self._delayedCallback();}else{self._callback();}},validate:function(){var self=this;return self.options.validation(self.element);}});})(jQuery);(function($){$.widget("indico.scrollblocker",{options:{overflowType:"scroll"},_create:function(){var element=this.element;var options=this.options;$("body").on("mousewheel wheel",function(e){var blocker=$(e.target).parentsUntil(element.parent()).filter(function(){return $(this).hasCSS("overflow-y",options.overflowType);});if(blocker.length>0){var wheelup=(e.originalEvent.wheelDelta||-e.originalEvent.deltaY)/120>0;if(blocker.scrollTop()===0&&wheelup){return false;}
if((blocker.scrollTop()+1>=(blocker.prop("scrollHeight")-blocker.outerHeight()))&&!wheelup){return false;}}
return true;});}});})(jQuery);(function($){'use strict';$.widget('indico.timerange',{options:{label:$T('Time'),initStartTime:'0:00',initEndTime:'23:59',startTimeName:'start_time',endTimeName:'end_time',wrapInToolbar:true,thinToolbar:true,errorHighlight:true,sliderWidth:'230px',change:null},_create:function(){var self=this;var element=self.element;var opt=self.options;var toolbar=element;var group=$('<div class="group with-slider timerange">');var label=$('<span class="i-button label heavy">').text(opt.label);var range=$('<span class="i-button label slider">').css('width',opt.sliderWidth);var thinClass=opt.thinToolbar?'thin':'';self._createInputs();self._createSlider();if(opt.wrapInToolbar){toolbar=$('<div class="toolbar {0}">'.format(thinClass));element.append(toolbar);}
group.append(label).append(self.startTime).append(range.append(self.slider)).append(self.endTime).appendTo(toolbar);},_createInputs:function(){var self=this;var opt=self.options;var typeWatchOptions={captureLength:0,highlight:false,wait:250,callback:function(){self._updateSlider();}};self.startTime=$('<input>',{type:'text',name:opt.startTimeName,maxlength:5,value:opt.initStartTime}).attr('placeholder','hh:mm').typeWatch(typeWatchOptions);self.endTime=$('<input>',{type:'text',name:opt.endTimeName,maxlength:5,value:opt.initEndTime}).attr('placeholder','hh:mm').typeWatch(typeWatchOptions);self.element.on('keydown','input',function(e){if($(e.target).prop('name')===opt.startTimeName){if(e.which===K.TAB){e.preventDefault();self.endTime.focus().select();}}else if($(e.target).prop('name')===opt.endTimeName){if(e.which===K.TAB&&e.shiftKey){e.preventDefault();self.startTime.focus().select();}}});},_createSlider:function(){var self=this;var opt=self.options;self.slider=$('<span>').slider({range:true,max:1439,values:[self.__getTime(opt.initStartTime),self.__getTime(opt.initEndTime)],step:5,start:function(e,ui){self._updateInputs(e,ui);},slide:function(e,ui){self._updateInputs(e,ui);self._trigger('change',this);}});},_setOption:function(key,value){if(key==='disabled'){this.slider.slider(value?'disable':'enabled');this.startTime.prop('disabled',!!value);this.endTime.prop('disabled',!!value);}
this._super(key,value);},_updateInputs:function(event,ui){var self=this;self._restoreHighlight();self.startTime.val(self.__getTimeString(ui.values[0]));self.endTime.val(self.__getTimeString(ui.values[1]));},_updateSlider:function(){var self=this;self._restoreHighlight();if(self.validate()){var sTime=self.__getTime(self.startTime.val());var eTime=self.__getTime(self.endTime.val());self.slider.slider('values',0,sTime).slider('values',1,eTime);self._trigger('change',this);}},_restoreHighlight:function(){var self=this;self.startTime.removeClass('hasError');self.endTime.removeClass('hasError');},__getTimeString:function(time){var minutes=parseInt(time%60,10);var hours=parseInt((time/60)%24,10);minutes=minutes+'';if(minutes.length===1){minutes='0'+minutes;}
return hours+':'+minutes;},__getTime:function(timeString){var time=timeString.split(':');return(Math.min(parseInt(time[0],10),23)*60)+Math.min(parseInt(time[1],10),59);},__validateTime:function(timeString){var time=timeString.split(':');var hours=parseInt(time[0],10);var minutes=parseInt(time[1],10);if(isNaN(hours)||isNaN(minutes)){return false;}
if(hours>23||minutes>59){return false;}
return true;},getStartTime:function(){var self=this;return self.startTime.val();},getEndTime:function(){var self=this;return self.endTime.val();},resetRange:function(){var self=this;self.startTime.val(self.options.initStartTime);self.endTime.val(self.options.initEndTime);self._updateSlider();},setStartTime:function(time){var self=this;self.startTime.val(time);self._updateSlider();},setEndTime:function(time){var self=this;self.endTime.val(time);self._updateSlider();},setMaxRange:function(){var self=this;self.startTime.val('0:00');self.endTime.val('23:59');self._updateSlider();},setMinRange:function(){var self=this;self.startTime.val('0:00');self.endTime.val('0:00');self._updateSlider();},validate:function(highlight){var self=this;var valid=true;var timeRe=/^\d{1,2}:\d{2}$/;var sTime=self.startTime.val();var eTime=self.endTime.val();if(highlight===undefined){highlight=self.options.errorHighlight;}
if(!sTime.match(timeRe)||!self.__validateTime(sTime)){valid=false;if(highlight){self.startTime.addClass('hasError');}}
if(!eTime.match(timeRe)||!self.__validateTime(eTime)){valid=false;if(highlight){self.endTime.addClass('hasError');}}
return valid;}});})(jQuery);(function($,global){'use strict';$.fn.stickyTooltip=function(category,content){return this.qtip({content:{text:content},position:{my:'left middle',at:'middle right'},hide:{'event':'click unfocus'},style:{classes:'qtip-'+category},show:{when:false,ready:true}});};global.repositionTooltips=function repositionTooltips(){$('.qtip').qtip('reposition');};})(jQuery,window);(function($){'use strict';$.widget("indico.nullableselector",{options:{nullvalue:"__None"},_create:function(){var self=this;var element=self.element;var opt=self.options;element.toggleClass('no-value',element.val()===opt.nullvalue);element.on('change',function(){$(this).toggleClass('no-value',$(this).val()===opt.nullvalue);});}});})(jQuery);(function($){'use strict';$.widget("indico.colorpicker",{options:{defaultColor:"ffffff"},_create:function(){var self=this;var element=self.element;var opt=self.options;var clickableWrapper=element.find('.clickable-wrapper');var preview=element.find('.color-preview');var colorInput=element.find('input');function updateColorPreview(color){preview.css('background',color).removeClass('no-value');}
function updateWidget(){preview.toggleClass('no-value',!colorInput.val().length);if(colorInput.val()){updateColorPreview(colorInput.val());clickableWrapper.ColorPickerSetColor(colorInput.val());}
else{preview.attr('style',null);}}
colorInput.on('input change',updateWidget);clickableWrapper.ColorPicker({color:opt.defaultColor,onSubmit:function(hsb,hex,rgb,el){$(el).val(hex);updateColorPreview('#'+hex);$(el).ColorPickerHide();},onChange:function(hsb,hex){colorInput.val('#'+hex);updateColorPreview('#'+hex);colorInput.trigger('input');},onShow:function(colorpicker){$(colorpicker).fadeIn(500);return false;},onHide:function(colorpicker){$(colorpicker).fadeOut(500);return false;}});updateWidget();}});})(jQuery);(function($){'use strict';$.widget('indico.palettepicker',{options:{availableColors:[],onSelect:null,numColumns:5,selectedColor:null,qtipConstructor:null},_create:function(){var self=this;var element=this.element;var paletteTable=$('<table>',{class:'palette-picker'});var availableColors=this.options.availableColors;var tr=this._createTableRow();self._paletteTable=paletteTable;$.each(availableColors,function(index,color){var td=$('<td>',{class:'palette-color',data:{color:color}});var colorBox=$('<div>',{css:{background:'#'+color.background},class:'background-box'});colorBox.append($('<div>',{css:{background:'#'+color.text},class:'text-box'}));td.append(colorBox);tr.append(td);if((index+1)%self.options.numColumns===0){paletteTable.append(tr);tr=self._createTableRow();}});if(tr.children().length){paletteTable.append(tr);}
paletteTable.on('click','.palette-color',function(){var $this=$(this);var color=$this.data('color');var backgroundColor='#'+color.background;var textColor='#'+color.text;var styleObject=element[0].style;self.options.selectedColor=color;self._updateSelection();styleObject.setProperty('color',textColor,'important');styleObject.setProperty('background',backgroundColor,'important');if(self.options.onSelect){self.options.onSelect.call(element,backgroundColor,textColor);}
element.qtip('hide');});var qtipOptions={prerender:false,overwrite:false,suppress:false,style:{classes:'palette-picker-qtip'},position:{my:'top center',at:'bottom center',target:element,adjust:{mouse:false,scroll:false}},content:{text:paletteTable},show:{event:'click',solo:true},hide:{event:'unfocus'},events:{show:self._updateSelection.bind(self)}};if(self.options.qtipConstructor){self.options.qtipConstructor(element,qtipOptions);}else{element.qtip(qtipOptions);}},_createTableRow:function(){return $('<tr>',{height:13});},_updateSelection:function(){var selectedColor=this.options.selectedColor;this._paletteTable.find('.palette-color').each(function(){var $this=$(this);var color=$this.data('color');if(selectedColor!==null&&color.background===selectedColor.background&&color.text===selectedColor.text){$this.addClass('selected');}else{$this.removeClass('selected');}});}});})(jQuery);(function($){$.widget('indico.itempicker',{options:{onSelect:null,checkedItemIcon:'icon-checkmark',uncheckedItemIcon:'icon-stop',items:null,footerElements:null,containerClasses:'',filterPlaceholder:$T.gettext('Type to filter...')},_create:function(){this.selectedItem=null;this._createItemsDict(this.options.items||this.element.data('items')||[]);var qbubbleContent=this._createQbubbleContent(this.itemsDict);this.element.qbubble({prerender:true,show:{ready:true},content:{text:qbubbleContent},style:{classes:'item-picker-qbubble {0}'.format(this.options.containerClasses)},position:{my:'right top',at:'left top'},events:{show:function(){_.defer(function(){function handleInput(){var $this=$(this);var textTyped=$this.val().trim().toLowerCase();var dropdownContainer=$this.closest('.dropdown-container');dropdownContainer.find('.dropdown-item').each(function(){var $item=$(this);var found=$item.data('filter').toLowerCase().indexOf(textTyped)!==-1;$item.toggle(found);});}
qbubbleContent.find('.filter-input').clearableinput({'onInput':handleInput,'onClear':handleInput,'focusOnStart':true}).focus();});}}});},_destroy:function(){self.element.qbubble('destroy');},_createItemsDict:function(items){var self=this;this.itemsDict={};$.each(items,function(index,data){self.itemsDict[data.id]={data:data,elem:null};});},_createQbubbleContent:function(items){var self=this;var dropdownContainer=$('<div>',{'class':'dropdown-container'});var filterWrapper=$('<div>',{'class':'dropdown-filter-wrapper'});var filterInput=$('<input>',{'type':'text','class':'filter-input','attr':{'placeholder':self.options.filterPlaceholder}});var itemsContainer=$('<div>',{'class':'dropdown-items-container'});filterWrapper.append(filterInput);dropdownContainer.append(filterWrapper);$.each(items,function(itemId,itemDict){var isSelected=(itemId==self.element.data('selected-item-id'));var itemData=itemDict.data;var itemIcon=$('<span>',{'class':'item-icon '+self.options.uncheckedItemIcon});var $item=itemDict.elem=$('<div>',{'class':'dropdown-item','data':{'filter':itemData.title,'id':itemId},'on':{'click':function(){self.hide();if(self.selectedItem&&itemId==self.selectedItem.id){self._handleSelect($item,null,itemData);}else{self._handleSelect($item,itemData,self.selectedItem);}}}});if(itemData.colors){itemIcon.css('color','#'+itemData.colors.background);}
$item.append($('<span>',{'class':self.options.checkedItemIcon+' active-item-icon'}));$item.append(itemIcon).append($('<span>',{'class':'item-title','text':itemData.title}));itemsContainer.append($item);if(isSelected){self._selectItem($item,itemData);}});dropdownContainer.append(itemsContainer);this._sortItems(itemsContainer);if(self.options.footerElements){self._appendFooterItems(dropdownContainer);}
return dropdownContainer;},updateItemList:function(items){this._createItemsDict(items);this.element.qbubble('option','content.text',this._createQbubbleContent(this.itemsDict));},selectItem:function(id){var newItem=id!==null?this.itemsDict[id].data:null;var newElem=this.itemsDict[id!==null?id:this.selectedItem.id].elem;this._handleSelect(newElem,newItem,this.selectedItem);},hide:function(){this.element.qbubble('hide');},_handleSelect:function(newElem,newItem,oldItem){var promise;var self=this;if($.isFunction(self.options.onSelect)){promise=self.options.onSelect.call(self.element,newItem,oldItem);}
if(promise===undefined){promise=$.Deferred().resolve();}
return promise.then(function(){if(newItem){self._selectItem(newElem,newItem);}else{self._deselectItem(newElem);}});},_selectItem:function(item,itemData){var itemsContainer=item.closest('.dropdown-items-container');var dropdownItems=itemsContainer.find('.dropdown-item');dropdownItems.css('background','').removeClass('active');itemsContainer.find('.item-title').css('color','');item.addClass('active');if(itemData.colors){item.css('background','#'+this._increaseBrightness(itemData.colors.background,50));item.find('.item-title').css('color','#'+this._getContrastYIQ(itemData.colors.background));}
this.selectedItem=itemData;this._sortItems(itemsContainer);},_sortItems:function(dropdownContainer){var self=this;var dropdownItems=dropdownContainer.find('.dropdown-item');dropdownItems.detach().sort(function(a,b){var $a=$(a);var $b=$(b);if(self.selectedItem&&$a.data('id')==self.selectedItem.id)return-1;if(self.selectedItem&&$b.data('id')==self.selectedItem.id)return 1;return strnatcmp($a.text().toLowerCase(),$b.text().toLowerCase());}).appendTo(dropdownContainer);},_deselectItem:function(item){this.selectedItem=null;item.css('background','').removeClass('active').find('.item-title').css('color','');this._sortItems(item.closest('.dropdown-items-container'));},_increaseBrightness:function(hex,percent){hex=hex.trim().replace(/^#/,'');if(hex.length==3){hex=hex.replace(/(.)/g,'$1$1');}
var r=parseInt(hex.substr(0,2),16),g=parseInt(hex.substr(2,2),16),b=parseInt(hex.substr(4,2),16);return((0|(1<<8)+r+(256-r)*percent/100).toString(16)).substr(1)+
((0|(1<<8)+g+(256-g)*percent/100).toString(16)).substr(1)+
((0|(1<<8)+b+(256-b)*percent/100).toString(16)).substr(1);},_getContrastYIQ:function(hexColor){var r=parseInt(hexColor.substr(0,2),16);var g=parseInt(hexColor.substr(2,2),16);var b=parseInt(hexColor.substr(4,2),16);var yiq=((r*299)+(g*587)+(b*114))/1000;return(yiq>=128)?'000':'FFF';},_appendFooterItems:function(container){var self=this;var footerElements=self.options.footerElements;container.append($('<div>',{'class':'divider'}));$.each(footerElements,function(){var $this=this;var actionButton=$('<div>',{'class':'action-row','text':$this.title,'on':{'click':function(){self.hide();if($.isFunction($this.onClick)){$this.onClick.call(actionButton,self.element);}}}});container.append(actionButton);});}});})(jQuery);(function(global){'use strict';global.setupSortableList=function setupSortableList($wrapper){if($wrapper.filter('.disable-if-locked').closest('.event-locked').length||$wrapper.closest('.disable-if-locked').closest('.event-locked').length){return;}
if($wrapper.data('disable-dragging')===undefined){var $lists=$wrapper.find('ul');$lists.sortable({connectWith:$lists,placeholder:'i-label sortable-item placeholder',containment:$wrapper,tolerance:'pointer',forcePlaceholderSize:true});}
function toggleEnabled($li){var $list=$li.closest('ul');var targetClass=$list.hasClass('enabled')?'.disabled':'.enabled';var $destination=$list.closest('.js-sortable-list-widget').find('ul'+targetClass);$li.detach().appendTo($destination);}
$wrapper.find('ul li .toggle-enabled').on('click',function(){toggleEnabled($(this).closest('li'));});$wrapper.find('.actions').on('mousedown',function(evt){evt.stopPropagation();});};})(window);(function($){'use strict';$.widget('indico.categorynavigator',{options:{category:0,actionButtonText:$T.gettext("Select"),confirmation:false,emptyCategoryText:$T.gettext("This category doesn't contain any subcategory"),openInDialog:false,dialogTitle:$T.gettext("Select a category"),dialogSubtitle:null,actionOn:{categoriesWithSubcategories:{disabled:false,message:$T.gettext("Not possible for categories containing subcategories")},categoriesWithEvents:{disabled:false,message:$T.gettext("Not possible for categories containing events")},categoriesWithoutEventCreationRights:{disabled:false,message:$T.gettext("Not possible for categories where you cannot create events")},categoriesDescendingFrom:{disabled:false,ids:[],message:$T.gettext('Not possible for categories descending from category "{0}"')},categories:{disabled:false,message:$T.gettext("Not possible for this category"),ids:[],groups:[]}},onAction:function(){}},_categories:{},_subcategories:{},_searchResultData:{},_currentCategoryRequest:null,_currentSearchRequest:null,_create:function(){var self=this;if(_.isObject(self.options.category)){self._fillCache(self.options.category);self._categoryId=self.options.category.category.id;}else{self._categoryId=self.options.category;}
if(self.options.openInDialog){self._createInDialog();}else{self._createInline();}},_createInline:function(){var self=this;self.element.addClass('categorynav');self._createList();self._createSearchField();self._createBindings();self.goToCategory(self._categoryId);},_createInDialog:function(){var self=this;var $content=$('<div>',{class:'categorynav-dialog-content'});ajaxDialog({title:self.options.dialogTitle,subtitle:self.options.dialogSubtitle,content:$content[0].outerHTML,closeButton:true,fullyModal:true,onOpen:function(dialog){self.element=dialog.contentContainer.children('.categorynav-dialog-content');self.dialog=dialog;self._createInline();}});},_createList:function(){var self=this;self.$category=$('<div>');self.$categoryTree=$('<ul>',{class:'group-list'});self.$categoryResultsList=$('<ul>',{class:'group-list search-results-list'});self.$categoryResultsInfo=$('<div>',{class:'search-result-info'});self.$spinner=$('<div>',{class:'spinner-wrapper'}).append($('<div>',{class:'i-spinner'}));self.$placeholderEmpty=$('<div>',{class:'placeholder'});self.$placeholderNoResults=$('<div>',{class:'placeholder'});self.$categoryList=$('<div>',{class:'category-list'}).append(self.$category).append(self.$categoryTree).append(self.$categoryResultsInfo).append(self.$categoryResultsList).append(self.$spinner).append(self.$placeholderEmpty).append(self.$placeholderNoResults);self._toggleSearchResultsView(false);self.element.append(self.$categoryList);},_createSearchField:function(){var self=this;self.$searchInput=$('<input>',{type:'search',placeholder:$T.gettext("Search")});self.element.prepend(self.$searchInput);self.$searchInput.realtimefilter({wait:500,callback:function(value){if(!value){self._clearSearch();}else{self.searchCategories(value);}}});},_createBindings:function(){var self=this;self.element.on('click','.js-action',function(evt){var $this=$(this);evt.stopPropagation();if(!$this.hasClass('disabled')){self._onAction($this.data('categoryId'));}});self.element.on('click','.js-go-to',function(evt){var categoryId=$(this).data('categoryId');self.goToCategory(categoryId);evt.preventDefault();});self.element.on('click','.js-navigate-up',function(){var parentId=$(this).data('parentId');self.goToCategory(parentId);});self.element.on('click','.js-search',function(){self.$searchInput.focus();self.$searchInput.effect('highlight',{color:Palette.highlight});});self.element.on('click','.js-clear-search',function(){self._clearSearch();});},_buildBreadcrumbs:function(path,clickable){var $breadcrumbs=$('<ul>',{class:'breadcrumbs'});var tag=clickable?'<a>':'<span>';_.each(path,function(category,idx){var $item=$('<li>');var $segment=$(tag,{'text':category.title,'data-category-id':category.id}).toggleClass('js-go-to',clickable);if(idx===0){$item.text($T.gettext("in")+" ");}
if(clickable){$segment.attr('href','');$segment.attr('title',$T.gettext("Go to: {0}".format(category.title)));}
$breadcrumbs.append($item.append($segment));});return $breadcrumbs;},_buildCategory:function(category,isSubcategory,withBreadcrumbs,clickableBreadcrumbs){var self=this;var tag=isSubcategory?'<li>':'<div>';var itemClass=isSubcategory?'subcategory':'current-category';var $category=$(tag,{class:'item '+itemClass,id:'category-'+category.id});var $categoryTitle=$('<div>',{class:'title-wrapper'});$categoryTitle.append($('<span>',{class:'title',text:category.title}));if(withBreadcrumbs&&category.parent_path.length){var $breadcrumbs=self._buildBreadcrumbs(category.parent_path,clickableBreadcrumbs);$categoryTitle.append($breadcrumbs);}
$category.append($('<div>',{class:'icon-wrapper'}));$category.append($categoryTitle);$category.append(self._buildSidePanel(category,isSubcategory));var $protectionIcon=$('<span>',{class:'protection',title:$T.gettext("This category is protected")}).toggleClass('icon-shield',category.is_protected);if(isSubcategory){var $protection=$('<div>',{class:'protection-wrapper'}).append($protectionIcon);$categoryTitle.before($protection);}else if(category.is_protected){$breadcrumbs.before($protectionIcon);}
return $category;},_buildCurrentCategory:function(category){var self=this;return self._buildCategory(category,false,true,true);},_buildSubcategory:function(category,withBreadcrumbs){var self=this;var $subcategory=self._buildCategory(category,true,withBreadcrumbs,false);if(category.can_access){$subcategory.addClass('can-access js-go-to');$subcategory.data('categoryId',category.id);}
return $subcategory;},_buildSidePanel:function(category,forSubcategory){var self=this;var $buttonWrapper=$('<div>',{class:'button-wrapper'});var $button=$('<span>',{'class':'action-button js-action','text':self.options.actionButtonText,'data-category-id':category.id});$buttonWrapper.append($('<div>').append($button));var canActOn=self._canActOn(category,true);if(!canActOn.allowed){$button.addClass('disabled').attr('title',canActOn.message);}
if(!forSubcategory&&category.parent_path&&category.parent_path.length){var parent=_.last(category.parent_path);var $arrowUp=$('<a>',{'class':'icon-arrow-up navigate-up js-navigate-up','title':$T.gettext("Go to parent: {0}".format(parent.title)),'data-parent-id':parent.id});$buttonWrapper.append($arrowUp);}
if(forSubcategory){var $info=$('<div>',{class:'stats icon-list',title:$T.ngettext("{0} category","{0} categories",category.deep_category_count).format(category.deep_category_count)+' | '+
$T.ngettext("{0} event","{0} events",category.deep_event_count).format(category.deep_event_count)});var $categories=$('<span>',{class:'categories-count',text:category.deep_category_count});var $events=$('<span>',{class:'events-count',text:category.deep_event_count});var $separator=$('<span>',{class:'stats-separator',text:' | '});$info.append($categories).append($separator).append($events);$buttonWrapper.append($info);}
return $buttonWrapper;},_buildPlaceholder:function(category){var self=this;var $placeholder=$('<div>').append($('<div>',{class:'placeholder-text',text:self.options.emptyCategoryText}));var parent=_.last(category.parent_path);var actionButtonText=self.options.actionButtonText.toLowerCase();var html;if(!category.parent_path.length){if(self._canActOn(category)){html=$T.gettext('You can only <a class="js-action" data-category-id="{0}">{1}</a> this one.').format(category.id,actionButtonText);}}else if(self._canActOn(category)){html=$T.gettext('You can <a class="js-action" data-category-id="{0}">{1}</a> this one, '+'<a class="js-navigate-up" data-parent-id="{2}">navigate up</a> '+'or <a class="js-search">search</a>.').format(category.id,actionButtonText,parent.id);}else{html=$T.gettext('You can <a class="js-navigate-up" data-parent-id="{2}">navigate up</a> '+'or <a class="js-search">search</a>.').format(category.id,actionButtonText,parent.id);}
$placeholder.append($('<div>',{html:html}));return $placeholder;},_buildNoResultsPlaceholder:function(){var $placeholder=$('<div>').append($('<div>',{class:'placeholder-text',text:$T.gettext("Your search doesn't match any category")})).append($('<div>',{html:$T.gettext('You can <a class="js-search">modify</a> or '+'<a class="js-clear-search">clear</a> your search.')}));return $placeholder;},_ellipsizeBreadcrumbs:function($category){var $breadcrumbs=$category.find('.breadcrumbs');var availableSpace=$category.find('.title-wrapper').width();var $ellipsis=$('<li>',{class:'ellipsis'});var shortened=false;if(!availableSpace){return;}
while($breadcrumbs.outerWidth()>=availableSpace){var $segments=$breadcrumbs.children(':not(.ellipsis)');var middleIndex=Math.floor($segments.length/2);if(!shortened){$segments.eq(middleIndex).replaceWith($ellipsis);}else{$segments.eq(middleIndex).remove();}}},_highlightQuery:function(query,$result){var $title=$result.find('.title');var title=$title.text();var indexStart=title.toLowerCase().search(query.toLowerCase());var indexEnd=indexStart+query.length;$title.html(title.substring(0,indexStart)+'<strong>'+title.substring(indexStart,indexEnd)+'</strong>'+title.substring(indexEnd));},_renderCurrentCategory:function(category){var self=this;var $currentCategory=self._buildCurrentCategory(category);self.$category.replaceWith($currentCategory);self.$category=$currentCategory;self._ellipsizeBreadcrumbs(self.$category);},_renderCategoryTree:function(subcategories,category){var self=this;_.each(subcategories,function(subcategory){self.$categoryTree.append(self._buildSubcategory(subcategory));});if(!subcategories.length){self.$placeholderEmpty.html(self._buildPlaceholder(category));}
self._postRenderList();},_renderSearchResults:function(categories,query){var self=this;self.$category.hide();self.$categoryResultsList.empty();self._toggleSearchResultsView(true);_.each(categories,function(category){var $result=self._buildSubcategory(category,true);if(category.is_favorite){$result.find('.icon-wrapper').append($('<i>',{class:'icon-star',title:$T.gettext("In favourite categories")}));}else{$result.find('.icon-wrapper').append($('<i>',{class:'icon-search',title:$T.gettext("Search result")}));}
self._highlightQuery(query,$result);self.$categoryResultsList.append($result);self._ellipsizeBreadcrumbs($result);});if(!categories.length){self.$placeholderNoResults.html(self._buildNoResultsPlaceholder());}else{self.$placeholderNoResults.empty();}
self._postRenderList();},_renderSearchResultInfo:function(count,totalCount){var self=this;var $stats=$('<span>',{class:'result-stats',text:totalCount?$T.gettext("Displaying {0} out of {1} results.").format(count,totalCount):$T.gettext("There are no results.")});if(totalCount!==count||!totalCount){$stats.text($stats.text()+' '+$T("Make the search more specific for more accurate results"));}
var $clear=$('<a>',{class:'clear js-clear-search',text:$T.gettext("Clear search")});self.$categoryResultsInfo.empty();self.$categoryResultsInfo.append($stats).append($clear).show();},_postRenderList:function(){var self=this;var statsMaxWidth=0;var $stats=self.$categoryList.find('.item:not(.hiding) .stats:visible');$stats.each(function(){var width=this.getBoundingClientRect().width;if(width>statsMaxWidth){statsMaxWidth=width;}});$stats.width(Math.ceil(statsMaxWidth));var hasProtectedCategories=!!self.$categoryTree.find('.icon-shield').length;self.$categoryTree.toggleClass('with-protected',hasProtectedCategories);self.$categoryTree.scrollTop(0);},_getCurrentCategory:function(id){var self=this;var dfd=$.Deferred();function resolve(){dfd.resolve(self._categories[id]);}
if(self._categories[id]){_.defer(resolve);}else{self._fetchCategory(id,resolve);}
return dfd.promise();},_getCategoryTree:function(id){var self=this;var dfd=$.Deferred();function resolve(){var subcategories=[];_.each(self._subcategories[id],function(scId){subcategories.push(self._categories[scId]);});dfd.resolve(subcategories,self._categories[id]);}
if(self._subcategories[id]){_.defer(resolve);}else{self._fetchCategory(id,resolve);}
return dfd.promise();},_getSearchResults:function(query){var self=this;var dfd=$.Deferred();function resolve(){dfd.resolve(self._searchResultData[query],query);}
if(self._searchResultData[query]){_.defer(resolve);}else{self._fetchSearchResults(query,resolve);}
return dfd.promise();},_fetchCategory:function(id,callback){var self=this;if(self._currentCategoryRequest&&self._currentCategoryRequest.categoryId===id){self._currentCategoryRequest.then(callback);return;}
self._currentCategoryRequest=$.ajax({url:build_url(Indico.Urls.Categories.info,{category_id:id}),dataType:'json',beforeSend:function(){self._toggleLoading(true,true);},complete:function(){self._toggleLoading(false,true);self._currentCategoryRequest=null;},error:function(xhr){if(xhr.status!==403){handleAjaxError(xhr);}},success:function(data){if(data&&self._isInDOM()){self._fillCache(data);callback();}}});self._currentCategoryRequest.categoryId=id;},_fetchReachableCategories:function(id){var self=this;$.ajax({url:build_url(Indico.Urls.Categories.infoFrom,{category_id:id}),method:'POST',dataType:'json',contentType:'application/json',data:JSON.stringify({exclude:_.map(_.keys(self._subcategories),function(n){return+n;})}),success:function(data){if(data){_.each(data.categories,function(category){self._fillCache(category);});}}});},_fetchSearchResults:function(query,callback){var self=this;function fillCache(data){self._searchResultData[query]=data;_.each(data.categories,self._fillSingleCategoryCache.bind(self));}
self._currentSearchRequest=$.ajax({url:build_url(Indico.Urls.Categories.search),data:{q:query},beforeSend:function(){if(self._currentSearchRequest!=null){self._currentSearchRequest.abort();}
self._toggleLoading(true);},complete:function(){self._toggleLoading(false);},error:function(jqXHR){if(jqXHR.statusText==='abort'){return;}
handleAjaxError(jqXHR);},success:function(data){if(data&&self._isInDOM()){fillCache(data);callback();}}});},_fillCache:function(data){var self=this;self._categories[data.category.id]=_.omit(data.category,'subcategories');self._subcategories[data.category.id]=_.pluck(data.subcategories,'id');_.each(data.subcategories,self._fillSingleCategoryCache.bind(self));_.each(data.supercategories,self._fillSingleCategoryCache.bind(self));},_fillSingleCategoryCache:function(category){var self=this;self._categories[category.id]=$.extend(self._categories[category.id],category);},_clearSearch:function(){var self=this;if(self._currentSearchRequest!=null){self._currentSearchRequest.abort();}
self.$category.show();self.$searchInput.realtimefilter('clear');self._toggleSearchResultsView(false);self.$placeholderNoResults.empty();self._toggleTreeView(true);},_onAction:function(categoryId){var self=this;function callback(){var res=self.options.onAction(self._categories[categoryId]);if(res===undefined){res=$.Deferred().resolve();}
res.then(function(){if(self.dialog){self.dialog.close();}});}
if(self.options.confirmation){var text=$T.gettext("You selected category <em>{0}</em>. Are you sure you want to proceed?").format(self._categories[categoryId].title);confirmPrompt(text,$T.gettext("Confirm action")).then(callback);}else{callback();}},_canActOn:function(category,withMessage){var self=this;var result={allowed:true,message:""};var canActOnCategories=self._canActOnCategories(category,true);var canActOnCategoriesDescendingFrom=self._canActOnCategoriesDescendingFrom(category,true);var canActOnCategoriesWithEvents=self._canActOnCategoriesWithEvents(category,true);var canActOnCategoriesWithSubcategories=self._canActOnCategoriesWithSubcategories(category,true);var canActOnCategoriesWithoutEventCreationRights=self._canActOnCategoriesWithoutEventCreationRights(category,true);if(!canActOnCategories.allowed){result=canActOnCategories;}else if(!canActOnCategoriesDescendingFrom.allowed){result=canActOnCategoriesDescendingFrom;}else if(!canActOnCategoriesWithEvents.allowed){result=canActOnCategoriesWithEvents;}else if(!canActOnCategoriesWithSubcategories.allowed){result=canActOnCategoriesWithSubcategories;}else if(!canActOnCategoriesWithoutEventCreationRights.allowed){result=canActOnCategoriesWithoutEventCreationRights;}
return withMessage?result:result.allowed;},_canActOnCategoriesWithoutEventCreationRights:function(category,withMessage){var self=this;var result={allowed:true,message:""};var categoriesWithoutEventCreationRights=self.options.actionOn.categoriesWithoutEventCreationRights;if(categoriesWithoutEventCreationRights.disabled&&!category.can_create_events){result.allowed=false;result.message=categoriesWithoutEventCreationRights.message;}
return withMessage?result:result.allowed;},_canActOnCategoriesWithSubcategories:function(category,withMessage){var self=this;var result={allowed:true,message:""};var hasSubcategories=!!category.deep_category_count;var categoriesWithSubcategories=self.options.actionOn.categoriesWithSubcategories;if(categoriesWithSubcategories.disabled&&hasSubcategories){result.allowed=false;result.message=categoriesWithSubcategories.message;}
return withMessage?result:result.allowed;},_canActOnCategoriesWithEvents:function(category,withMessage){var self=this;var result={allowed:true,message:""};var hasOnlyEvents=category.has_events&&!category.deep_category_count;var categoriesWithEvents=self.options.actionOn.categoriesWithEvents;if(categoriesWithEvents.disabled&&hasOnlyEvents){result.allowed=false;result.message=categoriesWithEvents.message;}
return withMessage?result:result.allowed;},_canActOnCategoriesDescendingFrom:function(category,withMessage){var self=this;var result={allowed:true,message:""};var categoriesDescendingFrom=self.options.actionOn.categoriesDescendingFrom;if(categoriesDescendingFrom.disabled){var id;var pathIds=_.pluck(category.parent_path,'id').reverse();var ids=categoriesDescendingFrom.ids;for(var i in pathIds){id=pathIds[i];if(_.contains(ids,id)){result.allowed=false;result.message=categoriesDescendingFrom.message.format(self._categories[id].title);break;}}}
return withMessage?result:result.allowed;},_canActOnCategories:function(category,withMessage){var self=this;var result={allowed:true,message:""};var categories=self.options.actionOn.categories;if(categories.disabled){if(_.contains(categories.ids,category.id)){result.allowed=false;result.message=categories.message;}else{for(var i in categories.groups){var group=categories.groups[i];if(_.contains(group.ids,category.id)){result.allowed=false;result.message=group.message;break;}}}}
return withMessage?result:result.allowed;},_toggleLoading:function(state,disableInput){var self=this;self.$categoryList.toggleClass('loading',state);if(disableInput){self.element.find('input').prop('disabled',state);}},_toggleTreeView:function(visible){var self=this;self.$category.toggle(visible);self.$categoryTree.toggle(visible);self.$placeholderEmpty.toggleClass('hidden',!visible);},_toggleSearchResultsView:function(visible){var self=this;self.$categoryResultsInfo.toggle(visible);self.$categoryResultsList.toggle(visible);},_isInDOM:function(){var self=this;return $.contains(document,self.element[0]);},goToCategory:function(id){var self=this;function render(){self._clearSearch();self.$categoryTree.empty();self._getCurrentCategory(id).then(self._renderCurrentCategory.bind(self));self._getCategoryTree(id).then(self._renderCategoryTree.bind(self));self._fetchReachableCategories(id);}
self.$placeholderEmpty.empty();if(!self.$categoryTree.is(':empty')){self.$categoryTree.slideUp(300,render);}else{render();}},searchCategories:function(query){var self=this;if(query.length<3){return;}
self._toggleTreeView(false);self._toggleSearchResultsView(false);self._getSearchResults(query).then(function(data,query){self._renderSearchResultInfo(data.categories.length,data.total_count);self._renderSearchResults(data.categories,query);});}});})(jQuery);(function($){'use strict';$.widget('indico.trackrolewidget',{options:{containerElement:null,userData:{}},_setUpRoleContainer:function($container){var self=this;var $addUserButton=$container.find('.add-user');var $field=$container.find('.js-user-data');var role=$container.data('roleId');var track=$container.closest('.js-track-config').data('trackId');var roleData=self.roleData[track][role];$field.val(JSON.stringify(_.map(roleData,_.propertyOf(self.options.userData))));$field.principalfield({allowExternalUsers:false,multiChoice:true,overwriteChoice:false,render:function(people){var $placeholder=$container.find('.placeholder');var $list=$container.find('.user-role-list').empty();$placeholder.toggle(!people.length);_.sortBy(people,_.property('name')).forEach(function(person){$list.append($('<li class="event-user">').text(person.name).append('<a class="remove-user icon-cross hide-if-locked">').attr('data-user-id',+person.id));});},onAdd:function(people){people.forEach(function(person){roleData.push(+person.id);self._update();});}});$container.on('click','.remove-user',function(evt){evt.preventDefault();var $userElement=$(this).closest('li');var userId=$userElement.data('userId');$userElement.remove();roleData=self.roleData[track][role]=_.without(roleData,userId);self._update();$field.principalfield('removeOne',userId);});$addUserButton.on('click',function(evt){evt.preventDefault();$field.principalfield('choose');});},_update:function(){this.element.val(JSON.stringify(this.roleData));},_setUp:function($trackConfig){var self=this;$trackConfig.find('.js-role-container').each(function(){self._setUpRoleContainer($(this));});},_create:function(){var self=this;var $container=self.options.containerElement;self.roleData=JSON.parse(self.element.val());$container.find('.js-track-config').each(function(){self._setUp($(this));});}});})(jQuery);(function($){'use strict';$.widget('indico.paperemailsettingswidget',{options:{containerElement:null,multipleRecipientOptions:['notify_on_added_to_event','notify_on_assigned_contrib','notify_on_paper_submission'],singleRecipientOptions:['notify_judge_on_review','notify_author_on_judgment']},_initCheckboxes:function(data){var self=this;var elementID=self.element.prop('id');var multipleRecipientOptions=self.options.multipleRecipientOptions;var singleRecipientOptions=self.options.singleRecipientOptions;multipleRecipientOptions.forEach(function(condition){data[condition].forEach(function(role){$('#{0}-{1}-{2}'.format(elementID,condition,role)).prop('checked',true);});});singleRecipientOptions.forEach(function(condition){$('#{0}-{1}'.format(elementID,condition)).prop('checked',data[condition]);});},_create:function(){var self=this;var element=self.element;var $container=self.options.containerElement;var hiddenData=element.val()?JSON.parse(element.val()):{};self._initCheckboxes(hiddenData);$container.find('.multiple-recipients input').on('change',function(){var setting=hiddenData[this.name];if(this.checked){setting.push(this.value);}else{setting.splice(setting.indexOf(this.value),1);}
element.val(JSON.stringify(hiddenData));});$container.find('.single-recipient input').on('change',function(){hiddenData[this.name]=this.checked;element.val(JSON.stringify(hiddenData));});}});})(jQuery);